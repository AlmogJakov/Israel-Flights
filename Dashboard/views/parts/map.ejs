<!DOCTYPE html>
<!--
    https://www.bingmapsportal.com/Application#    
    https://www.bing.com/api/maps/sdk/mapcontrol/isdk/loadmapasync#JS
    https://docs.microsoft.com/en-us/bingmaps/v8-web-control/map-control-concepts/pushpins/custom-image-pushpin-example    
    https://www.bigdatacloud.com/geocoding-apis
-->
<html>

<head>
    <title></title>
    <meta charset="utf-8" />
    <!-- Reference to the Bing Maps SDK -->
    <!-- Should call 'bing' with https (not http) to work with Heroku -->
    <script type='text/javascript'
        src='https://www.bing.com/api/maps/mapcontrol?callback=GetMap&key=Av1tVjvviT_3a3JIBRJZNPhFNKHiCTqGL9C5rD7uAAVU2KFgx16V3NjFP58VCBvk'
        async defer>
    </script>
    <script type="text/javascript">
    //let socket;
        //var map = null;
        var map, infobox, tooltip;
        var tooltipTemplate = '<div style="border-radius: 0.45rem;background-color:white;width:150px;padding:5px; padding-top:7px;text-align:center"><b>{title}</b></div>';
        function setMap() {
            socket = io.connect();
            socket.on('flights', function (msg) {
                add(msg);
            });
            // alert("connected");
            // map styles: https://docs.microsoft.com/en-us/bingmaps/articles/custom-map-styles-in-bing-maps
            var myStyle = {
                "version": "1.0",
                "settings": {
                    "landColor": "#0B334D"
                },
                "elements": {
                    // "point": {
                    //     "labelVisible": true,
                    //     "visible":true,
                    //     "overflow":true,
                    // },
                    // "countryRegion": {
                    //     "borderVisible": false,
                    // },

                    "mapElement": {
                        "labelColor": "#FFFFFF",
                        "labelOutlineColor": "#000000"
                    },
                    "political": {
                        "borderStrokeColor": "#144B53",
                        "borderOutlineColor": "#00000000"
                    },
                    "point": {
                        "iconColor": "#0C4152",
                        "fillColor": "#000000",
                        "strokeColor": "#0C4152"
                    },
                    "transportation": {
                        "strokeColor": "#000000",
                        "fillColor": "#000000"
                    },
                    "highway": {
                        "strokeColor": "#158399",
                        "fillColor": "#000000"
                    },
                    "controlledAccessHighway": {
                        "strokeColor": "#158399",
                        "fillColor": "#000000"
                    },
                    "arterialRoad": {
                        "strokeColor": "#157399",
                        "fillColor": "#000000"
                    },
                    "majorRoad": {
                        "strokeColor": "#157399",
                        "fillColor": "#000000"
                    },
                    "railway": {
                        "strokeColor": "#146474",
                        "fillColor": "#000000"
                    },
                    "structure": {
                        "fillColor": "#115166"
                    },
                    "water": {
                        "fillColor": "#021019"
                    },
                    "area": {
                        "fillColor": "#115166"
                    }
                }
            };
            // Initialize the map - USE YOUR OWN KEY !
            map = new Microsoft.Maps.Map(document.getElementById("myMap"), { 
                credentials: "Av1tVjvviT_3a3JIBRJZNPhFNKHiCTqGL9C5rD7uAAVU2KFgx16V3NjFP58VCBvk", customMapStyle: myStyle,
                allowHidingLabelsOfRoad: false
            });
			map.setView({
                //mapTypeId: Microsoft.Maps.MapTypeId.aerial,
                center: new Microsoft.Maps.Location(33.027222, 32.0225),
                zoom: 6,
                labelOverlay: Microsoft.Maps.LabelOverlay.visible,
                // labelOverlay: Microsoft.Maps.LabelOverlay.hidden,
                mapTypeId: Microsoft.Maps.MapTypeId.road,
                // showMapLabels: true,
                // allowHidingLabelsOfRoad: false,
            });

            //Create an infobox to use as a tooltip when hovering.
            tooltip = new Microsoft.Maps.Infobox(map.getCenter(), {
                visible: false,
                showPointer: false,
                showCloseButton: false,
                offset: new Microsoft.Maps.Point(-75, 20)
            });
            tooltip.setMap(map);
            //Create an infobox for displaying detailed information.
            infobox = new Microsoft.Maps.Infobox(map.getCenter(), {
                visible: false
            });
            infobox.setMap(map);
        }
    </script>

    <script type='text/javascript'>
		// rotation
		// source: https://social.msdn.microsoft.com/Forums/sqlserver/en-US/02de6b85-ee3d-4780-a4fd-3b944f0fc1b4/rotate-custom-image-pushpin?forum=bingmapsajax
		// source: https://www.anycodings.com/1questions/5317334/how-to-rotate-pushpin-image-in-bing-map#:~:text=https%3A//bingmapsv8samples.azurewebsites.net/%23Pushpin_RotatedImage
		// source: https://github.com/microsoft/BingMapsV8CodeSamples/blob/main/Samples/Pushpins/Rotated%20Image/Pushpin%20Rotated%20Image.html
		// source: https://docs.microsoft.com/en-us/bingmaps/v8-web-control/map-control-concepts/pushpins/custom-canvas-pushpin-example
		// FIX: https://stackoverflow.com/questions/5820209/image-onload-event-not-working-in-chrome
		function createRotatedImagePushpin(location, url, rotationAngle, flightData, callback) {
			var img = new Image();
			img.onload = function () {
				var c = document.createElement('canvas');

				var rotationAngleRads = rotationAngle * Math.PI / 180;

			   //Calculate rotated image size.
				// c.width = Math.abs(Math.ceil(img.width * Math.cos(rotationAngleRads) + img.height * Math.sin(rotationAngleRads)));
				// c.height = Math.abs(Math.ceil(img.width * Math.sin(rotationAngleRads) + img.height * Math.cos(rotationAngleRads)));
                c.width = 45;
				c.height = 45;
				var context = c.getContext('2d');

				//Move to the center of the canvas.
				context.translate(c.width / 2, c.height / 2);

				//Rotate the canvas to the specified angle in degrees.
				context.rotate(rotationAngleRads);

				//Draw the image, since the context is rotated, the image will be rotated also.
				context.drawImage(img, -img.width / 2, -img.height / 2);

				var pin = new Microsoft.Maps.Pushpin(location, {
					//Generate a base64 image URL from the canvas.
					icon: c.toDataURL(),
                    roundClickableArea: true,
                    //title: filghtID,
					anchor: new Microsoft.Maps.Point(c.width / 2, c.height / 2) //Anchor to center of image.
				});
                
                var src_dst_details = ""
                if (flightData['source'] != null && flightData['destination'] !=null) {
                    src_dst_details = flightData['source'] + " -> " + flightData['destination'];
                }
                
                pin.metadata = {
                    title: 'ID: ' + flightData['id'] + "<br>" 
                    + "<span style=\"display:inline-block; padding-top: 2px; font-weight:normal; font-family:secondayFont;\">" + "Global ID: " + flightData['global_id'] + "</span><br>"
                    + "<span style=\"font-weight:normal; font-family:secondayFont;\">" + src_dst_details + "</span>",
                    description: 'Discription for pin ' + flightData['id']
                };

                //Add a mouse events to the pushpin.
                //Microsoft.Maps.Events.addHandler(pin, 'click', pushpinClicked);
                Microsoft.Maps.Events.addHandler(pin, 'mouseover', pushpinHovered);
                Microsoft.Maps.Events.addHandler(pin, 'mouseout', closeTooltip);
                
				if (callback) {
					callback(pin);
				}
			};

			//Allow cross domain image editting.
			img.crossOrigin = 'anonymous';
			img.src = url;
		}
		// end rotation
		
        async function add(flightsData) {
            var json = JSON.parse(flightsData)
            var keys = Object.keys(json);
            var pinsPromises = [];
            var resultPinsValues = [];
            for (var i = 0; i < keys.length; i++) {
                var filghtID = keys[i];
                var flightData = json[filghtID][0];
                var coordinate_x = JSON.stringify(flightData['coordinate_x']);
                var coordinate_y = JSON.stringify(flightData['coordinate_y']);
                var degree = JSON.stringify(flightData['degree']);
                var loc = new Microsoft.Maps.Location(coordinate_x, coordinate_y);
                
			    // pinsPromises.push(await createRotatedImagePushpin(loc, 'airplane.png', degree, filghtID, function (pin) {
				//     //map.entities.push(pin);
                //     //pinsPromises.push(pin);
                //     //return pin;
			    // }));
                var pinFunc =
                    new Promise(async function (resolve, reject) {
                        await createRotatedImagePushpin(loc, 'airplane.png', degree, flightData, function (pin) {
                            resolve(pin);
                        });
                    });

                pinsPromises.push(pinFunc);
                await Promise.all(pinsPromises).then((values) => {
                    resultPinsValues = values;
                });
                // map.entities.clear();
                // for (const pinV of resultPinsValues) {
                //     map.entities.push(pinV);
                // }
            }
            map.entities.clear();
            for (const pinV of resultPinsValues) {
                map.entities.push(pinV);
            }
        }

        function move() {
            for (var i = map.entities.getLength() - 1; i >= 0; i--) {
                var pushpin = map.entities.get(i);
                if (pushpin instanceof Microsoft.Maps.Pushpin) {
                    map.entities.removeAt(i);
                }
            }
        }

        function pushpinHovered(e) {
        //Hide the infobox
        infobox.setOptions({ visible: false });
        //Make sure the infobox has metadata to display.
        if (e.target.metadata) {
            //Set the infobox options with the metadata of the pushpin.
            tooltip.setOptions({
                location: e.target.getLocation(),
                htmlContent: tooltipTemplate.replace('{title}', e.target.metadata.title),
                visible: true
            });
        }
    }
    
    function closeTooltip() {
        //Close the tooltip.
        tooltip.setOptions({
            visible: false
        });
    }

    function pushpinClicked(e) {
        //Hide the tooltip
        closeTooltip();
        //Make sure the infobox has metadata to display.
        if (e.target.metadata) {
            //Set the infobox options with the metadata of the pushpin.
            infobox.setOptions({
                location: e.target.getLocation(),
                title: e.target.metadata.title,
                description: e.target.metadata.description,
                visible: true
            });
        }
    }
		
		
    </script>

    <script>
        //let socket;

        //function initSocket() {
        //socket is global
        //socket = io.connect();
        //alert("connected");
        //socket = io.connect();
        //socket.on('flights', function (msg) {
        //    console.log("ffff");
        //    add();
        //});
        //}<body onload="initSocket()"></body>
    </script>
    
</head>

<body onload="setMap()">
    <div class="map-container">
        <div class="map" id="myMap"></div>
        <!-- <input type="button" onclick="add()" value="הוסף אייקונים" />
        <input type="button" onclick="move()" value="הסר אייקונים" /> -->
    </div>
</body>
</body>

</html>